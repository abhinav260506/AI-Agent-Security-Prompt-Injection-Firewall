import{D as p}from"./DirectiveScanner-BBzwnKX8.js";const T=["ignore","previous","instruction","password","system","override","credit","card","bank","transfer","debug","admin","root","cookies","export","browser","server","hacked","pwned"],E={name:"HiddenText",scanNode(e){if(e.nodeType!==Node.ELEMENT_NODE||e.hasAttribute("data-surgical-scanned")||e.classList.contains("surgical-guard-warning"))return null;const s=e.tagName.toUpperCase();if(["SCRIPT","STYLE","NOSCRIPT","LINK","META","HEAD","TITLE","SVG","PATH","G","IFRAME"].includes(s)||s==="INPUT"&&e.type==="hidden"||s==="BUTTON"||s==="SELECT"||s==="TEXTAREA"||s==="PROGRESS"||e.getAttribute("aria-hidden")==="true"||e.getAttribute("aria-busy")==="true"||e.getAttribute("role")==="progressbar")return null;const t=e.innerText||e.textContent;if(!t||t.trim().length===0||t.length>50&&!t.includes(" ")||/^[A-Za-z0-9+/=]+$/.test(t.trim())&&t.length>20)return null;const n=window.getComputedStyle(e),r=[];let a=0;n.display==="none"&&(r.push("Element has display: none"),a+=1),n.visibility==="hidden"&&(r.push("Element has visibility: hidden"),a+=1),parseFloat(n.opacity)<.05&&(r.push("Element transparency is near 0"),a+=1);const o=parseFloat(n.fontSize);if(o<1&&o>0&&(r.push(`Font size is extremely small (${o}px)`),a+=.8),this.areColorsEqual(n.color,n.backgroundColor)&&n.backgroundColor!=="rgba(0, 0, 0, 0)"&&(r.push("Text color matches background color"),a+=.9),n.position==="absolute"||n.position==="fixed"){const i=parseFloat(n.left),l=parseFloat(n.top);(i<-1e3||l<-1e3)&&(r.push("Element positioned far off-screen"),a+=.8)}return a>.5&&T.some(l=>t.toLowerCase().includes(l))?{detected:!0,type:"HIDDEN_TEXT",score:a,reasoning:r,node:e}:null},areColorsEqual(e,s){return e===s}},d={sanitizeText(e,s){let t=e;return s.forEach(n=>{if(n.type==="MALICIOUS_DIRECTIVE"){const r=` [ðŸš« BLOCKED: Unauthorized Command (${n.subtype}) ] `,a=n.match.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(a,"g");t=t.replace(o,r)}else if(n.type==="ROLE_CONFLICT"){const r=` [ðŸš« BLOCKED: Context Hijacking (${n.context}) ] `;t=t.replace(n.match,r)}}),t},sanitizeRange(e,s){try{let t=" [ ðŸš« Dangerous Directive Neutralized ] ",n="Surgical-Guard has neutralized this content.";if(typeof s=="object"){const o=s;o.type==="ROLE_CONFLICT"?(t=` [ ðŸš« Blocked: ${o.subtype} ] `,n=`Semantic Analysis Result: ${o.reasoning[0]}`):o.type==="MALICIOUS_DIRECTIVE"&&(t=` [ ðŸš« Command Removed: ${o.subtype} ] `)}const r=e.commonAncestorContainer.nodeType===1?e.commonAncestorContainer:e.commonAncestorContainer.parentNode;r&&["aria-label","title","alt","placeholder","data-content","value"].forEach(i=>{r.hasAttribute(i)&&(r.removeAttribute(i),console.log(`Surgical-Guard: Scrubbed attribute '${i}' from parent.`))});const a=document.createElement("span");return a.style.backgroundColor="#fee2e2",a.style.color="#dc2626",a.style.border="1px solid #ef4444",a.style.padding="2px 4px",a.style.borderRadius="4px",a.style.fontWeight="bold",a.style.fontSize="0.9em",a.style.cursor="not-allowed",a.style.userSelect="none",a.innerText=t,a.title=n,a.setAttribute("data-surgical-sanitized","true"),e.deleteContents(),e.insertNode(a),r&&(r.tagName==="BUTTON"||r.tagName==="INPUT"||r.tagName==="A")&&(r.disabled=!0,r.style.pointerEvents="none",r.style.opacity="0.6",r.href="javascript:void(0)"),!0}catch(t){return console.warn("Surgical-Guard: Failed to sanitize range",t),!1}},sanitizeNode(e,s){if(s.type==="HIDDEN_TEXT"){e.style.display="block",e.style.visibility="visible",e.style.opacity="1",e.style.fontSize="12px",e.style.color="red",e.style.backgroundColor="#ffe6e6",e.style.border="1px solid red",e.style.position="static",e.setAttribute("data-surgical-scanned","true"),e.classList.add("surgical-guard-warning");const t=document.createElement("strong");t.innerText="[HIDDEN CONTENT EXPOSED]: ",e.prepend(t),["aria-label","title","alt"].forEach(n=>e.removeAttribute(n))}}};class S{constructor(s){this.root=s,this.textSegments=[],this.fullText="",this._buildMap(s)}_buildMap(s){this._traverse(s)}_traverse(s){if(s.nodeType===Node.TEXT_NODE){const t=s.nodeValue;if(t){const n=this.fullText.length;this.fullText+=t;const r=this.fullText.length;this.textSegments.push({type:"text",node:s,start:n,end:r,text:t})}return}if(s.nodeType===Node.ELEMENT_NODE){const t=window.getComputedStyle(s);if(t.display==="none"||t.visibility==="hidden"||t.opacity==="0")return;const n=this._isBlock(t.display);s.childNodes.forEach(r=>this._traverse(r)),n?this._addVirtualSeparator(`
`):s.tagName==="BR"&&this._addVirtualSeparator(`
`)}}_isBlock(s){return s==="block"||s==="flex"||s==="grid"||s==="table"||s==="list-item"||s.startsWith("table-")}_addVirtualSeparator(s){const t=this.fullText.length;this.fullText+=s;const n=this.fullText.length;this.textSegments.push({type:"virtual",start:t,end:n,text:s})}getText(){return this.fullText}getRanges(s,t){const n=[];let r=s;for(const a of this.textSegments)if(a.type!=="virtual"&&a.end>r&&a.start<t){const o=Math.max(r,a.start),i=Math.min(t,a.end),l=o-a.start,c=i-a.start;if(c>l){const u=document.createRange();u.setStart(a.node,l),u.setEnd(a.node,c),n.push(u)}}return n}}class x{constructor(){this.detectors=[E,p]}async scanPage(s=document.body){const t={matches:[],sanitizedCount:0},n=s.getElementsByTagName("*");for(let o of n){const i=E.scanNode(o);i&&(t.matches.push(i),d.sanitizeNode(o,i),t.sanitizedCount++)}const r=new S(s),a=r.getText();if(!a||a.trim().length===0)return t;try{console.log("Surgical-Guard: Running Fast Path (Regex)...");const o=p.scanText(a);o.length>0&&(console.log(`Surgical-Guard: Fast Path matched ${o.length} threats. Sanitizing immediately.`),o.forEach(i=>{if(i.index!==void 0&&i.end!==void 0){const l=r.getRanges(i.index,i.end);let c=!1;l.forEach(u=>{d.sanitizeRange(u,i)&&(c=!0)}),c&&(t.sanitizedCount++,i.sanitized=!0)}t.matches.push(i)}))}catch(o){console.error("Surgical-Guard: Fast Path error",o)}try{console.log("Surgical-Guard: Awaiting Semantic Analysis...");const o=await chrome.runtime.sendMessage({type:"ANALYZE_TEXT",payload:{text:a}});o&&o.findings&&o.findings.forEach(l=>{if(l.index!==void 0&&l.end!==void 0){const c=r.getRanges(l.index,l.end);console.log(`Surgical-Guard: Match found "${(l.match||"").substring(0,20)}...". Mapped to ${c.length} DOM ranges.`);let u=!1;c.forEach(y=>{d.sanitizeRange(y,l)&&(u=!0)}),u&&(t.sanitizedCount++,l.sanitized=!0)}t.matches.push(l)})}catch(o){console.error("Surgical-Guard: Failed to get analysis from background.",o)}return t}async processContent(s){let t=[];try{const r=await chrome.runtime.sendMessage({type:"ANALYZE_TEXT",payload:{text:s}});r&&r.findings&&(t=r.findings)}catch(r){console.error("Surgical-Guard: processContent background error",r)}const n=d.sanitizeText(s,t);return{original:s,cleaned:n,findings:t}}}console.log("Surgical-Guard: Firewall Active");const b=new x;let m=!1;function C(){if(document.getElementById("surgical-guard-shield"))return;const e=document.createElement("div");e.id="surgical-guard-shield",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.backgroundColor="rgba(255, 255, 255, 0.98)",e.style.zIndex="2147483647",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="center",e.style.fontFamily="system-ui, -apple-system, sans-serif",e.style.transition="opacity 0.3s ease";const s=document.createElement("div");s.innerText="ðŸ›¡ï¸",s.style.fontSize="48px",s.style.marginBottom="20px",s.style.animation="pulse 1.5s infinite";const t=document.createElement("div");t.innerText="Surgical-Guard Analyzing...",t.style.fontSize="24px",t.style.fontWeight="600",t.style.color="#333";const n=document.createElement("div");n.innerText="Verifying content safety with AI",n.style.fontSize="14px",n.style.color="#666",n.style.marginTop="8px";const r=document.createElement("style");r.innerHTML=`
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
    `,document.head.appendChild(r),e.appendChild(s),e.appendChild(t),e.appendChild(n),document.body.appendChild(e),document.body.style.overflow="hidden"}function A(){const e=document.getElementById("surgical-guard-shield");e&&(e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e),document.body.style.overflow=""},300))}async function h(e=!1){console.log(`Surgical-Guard: Scanning page... (Silent: ${e})`),e||C(),m=!0;let s=[];if(window.location.hostname.includes("mail.google.com")){const n=document.querySelectorAll(".a3s");n.length>0&&(s=Array.from(n))}else s=[document.body];const t={matches:[],sanitizedCount:0};try{for(const n of s){const r=await b.scanPage(n);t.matches.push(...r.matches),t.sanitizedCount+=r.sanitizedCount}if(t.matches.length>0){console.group("ðŸš¨ Surgical-Guard: Threats Detected! ðŸš¨"),console.warn(`Found ${t.matches.length} threats.`);let n=document.title;if(window.location.hostname.includes("mail.google.com")){const a=document.querySelector("h2.hP");a&&(n=a.innerText)}const r=new Date().toISOString();chrome.runtime.sendMessage({type:"THREATS_DETECTED",payload:{count:t.matches.length,matches:t.matches,context:{title:n,url:window.location.href,timestamp:r}}}),console.groupEnd()}else console.log("Surgical-Guard: No threats detected."),chrome.runtime.sendMessage({type:"SAFE",payload:{count:0}})}catch(n){console.error("Surgical-Guard: Scan error",n)}finally{e||A(),setTimeout(()=>{m=!1},1e3)}return t}let f=!1;chrome.runtime.onMessage.addListener((e,s,t)=>{if(e.type==="MANUAL_SCAN")return console.log("Surgical-Guard: Manual scan requested."),f=!0,setTimeout(async()=>{await h(!1),t({status:"COMPLETE"})},10),!0});let g=null;const w=new MutationObserver(e=>{try{if(!f||m)return;g&&clearTimeout(g);let s=500;e.some(n=>{if(!n.target)return!1;const r=n.target.nodeType===1?n.target:n.target.parentElement;return r&&r.closest&&r.closest(".a3s")})&&(s=100,console.log("Surgical-Guard: Fast scan triggered for Email Body.")),g=setTimeout(async()=>{try{if(document.hidden)return;await h(!0)}catch(n){console.error("Surgical-Guard: Scan failed safely",n)}},s)}catch(s){console.error("Surgical-Guard: Critical Observer Error",s)}});try{w.observe(document.body,{childList:!0,subtree:!0})}catch(e){console.warn("Surgical-Guard: Could not start observer",e)}setTimeout(()=>{console.log("Surgical-Guard: Auto-starting protection..."),f=!0,h(!1).catch(e=>console.error("Surgical-Guard: Auto-run error",e))},500);
